# -*- coding: utf-8 -*-
import vkrequests as vkr
from utils import parse_input

from threading import Thread
import requests
import time
import json
import re
import math

__version__ = '0.1.0-demo'
__author__ = 'Eugene Ershov - https://vk.com/fogapod'
__source__ = 'https://github.com/Fogapod/ChatBot/tree/qpy2.7'
    
__help__ = '''
–í–µ—Ä—Å–∏—è: {ver}

–Ø —É–º–µ—é:
*–ì–æ–≤–æ—Ä–∏—Ç—å —Ç–æ, —á—Ç–æ –≤—ã –ø–æ–ø—Ä–æ—Å–∏—Ç–µ
(/say ... |/—Å–∫–∞–∂–∏ ... )
*–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
(/calculate ... |/–ø–æ—Å—á–∏—Ç–∞–π ... ) =
*–ü—Ä–æ–≤–µ—Ä—è—Ç—å, –ø—Ä–æ—Å—Ç–æ–µ –ª–∏ —á–∏—Å–ª–æ
(/prime ... |/–ø—Ä–æ—Å—Ç–æ–µ ... ) %
*–í—ã–∑—ã–≤–∞—Ç—å –ø–æ–º–æ—â—å
(/help |/–ø–æ–º–æ—â—å ) ?

–í –∫–æ–Ω—Ü–µ –º–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç–∞–≤–∏—Ç—Å—è –∑–Ω–∞–∫ –≤–µ—Ä—Ö–Ω–µ–π –∫–∞–≤—ã—á–∫–∏'

–ê–≤—Ç–æ—Ä: {author}
–ú–æ–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥: {source}
'''.format(\
    ver = __version__, author = __author__, source = __source__
)

# qpy
import logging
logging.captureWarnings(True)
import sys
reload(sys)
sys.setdefaultencoding('utf-8')
# qpy

class LongPollSession(object):
    def __init__(self, bot):
        self.bot = bot
        self.run_self = True

    def __exit__(self):
        self.run_message_long_poll_process = False
        self.message_long_poll_response = []
        exit()

    def authorization(self, token_path):
        authorized = False
        try:
            with open(token_path, 'r') as token_file:
                token = token_file.readlines()[0][:-1]
        except IOError:
            token = None

        if token:
            if vkr.log_in(token=token):
                self.SELF_ID = vkr.get_user_id()
                authorized = True
            else:
                open(token_path, 'w').close()

        else:
            login, password = raw_input('Login: '), raw_input('Password: ')
            new_token = vkr.log_in(login=login, password=password)
            if new_token:
                with open(token_path, 'w') as token_file:
                    token_file.write('{}\n{}'.format(\
                        new_token, '–ù–ò–ö–û–ú–£ –ù–ï –ü–û–ö–ê–ó–´–í–ê–ô–¢–ï –°–û–î–ï–†–ñ–ò–ú–û–ï –≠–¢–û–ì–û –§–ê–ô–õ–ê'
                        )
                    )
                self.SELF_ID = vkr.get_user_id()
                authorized = True

        return authorized

    def _make_message_long_poll_url(self, keep_ts=False):
        """
        :keep_ts:
            –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ ts, –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Å–æ–±—ã—Ç–∏—è {ts: 12345, updates: []} 
            (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è mlpd –∑–∞–ø–æ–ª–Ω–µ–Ω—ã)
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –≥–æ—Ç–æ–≤—ã–π url –¥–ª—è –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è long poll –∑–∞–ø—Ä–æ—Å–∞
        """
        if keep_ts:
            self.mlpd['ts'] = keep_ts
        else: 
            self.mlpd = vkr.get_message_long_poll_data()

        if self.mlpd:
            url_pattern = 'https://{server}?act={act}&key={key}&ts={ts}&wait={w}&mode={m}&version={v}'
            url = url_pattern.format(
                server = self.mlpd['server'],
                key = self.mlpd['key'],
                ts = self.mlpd['ts'],
                act = 'a_check',
                w = 100,
                m = 130,
                v = 1
            )
            return url

    def _listen_message_long_poll(self):
        """
        –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (–Ω—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–æ—Ç–æ–∫–æ–º)
        –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è –º–µ–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π message_long_poll_response —Å None –Ω–∞ –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        """
        print('{decor}{txt}{decor}'.format(decor='-'*6, txt='Listening long poll'))

        while self.run_message_long_poll_process:
            if not self.message_long_poll_response:
                self.message_long_poll_response = vkr.do_message_long_poll_request(url=self.message_long_poll_url)
            else:
                # –ø—Ä–æ—à–ª—ã–π –æ—Ç–≤–µ—Ç –µ—â—ë –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
                time.sleep(0.01)

    def flood(self, chat_id):
        while True:
            ans = raw_input('–ù–∞—á–∞—Ç—å —Ñ–ª—É–¥ –≤ {}? (Y/N) '.format(chat_id)) 
            if ans.upper() == 'Y':
                print('–ù–∞—á–∏–Ω–∞—é —Ñ–ª—É–¥–∏—Ç—å...')
                for i in range(1000):
                    vkr.send_message(text=str(i+1),uid=chat_id,rnd_id=i)
                    time.sleep(2)
            elif ans.upper() == 'N':
                break
            else:
                print('–û—Ç–≤–µ—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ')

    def process_updates(self):
        print (__help__)
        self.mlpd = None # message_long_poll_data
        #{
        #   server: str,
        #   key: int,
        #   ts: int
        #}
        self.message_long_poll_url = self._make_message_long_poll_url()
        self.message_long_poll_process = Thread(target=self._listen_message_long_poll)
        self.message_long_poll_response = None
        self.run_message_long_poll_process = True
        self.message_long_poll_process.start()

        self.last_rnd_id = 0
        self.reply_count = 0

        while True:
            if not self.message_long_poll_response:
                time.sleep(1)
                continue

            response = json.loads(self.message_long_poll_response.content)
            try:
                self.message_long_poll_url = self._make_message_long_poll_url(keep_ts=response['ts'])
            except KeyError:
                if 'failed' in response:
                    self.mlpd = None
                    self.message_long_poll_url = self._make_message_long_poll_url()
                    self.message_long_poll_response = None
                    continue

            self.message_long_poll_response = None

            print(response)

            for update in response['updates']:
                if  update[0] == 4 and\
                    update[8] != self.last_rnd_id and\
                    update[6] != '':
                # response == message
                # message != last_message
                # message != ''
                    text = update[6]
                    mark_msg = True
                else:
                    continue

                if  text.lower() == '–µ—Ä—à–æ–≤' or\
                    text.lower() == '–∂–µ–Ω—è' or\
                    text.lower() == '–∂–µ–Ω—å' or\
                    text.lower() == '–∂–µ–Ω—å–∫–∞' or\
                    text.lower() == '–∂–µ–∫–∞' or\
                    text.lower() == '–µ–≤–≥–µ–Ω–∏–π' or\
                    text.lower() == '–µ—Ä—à' or\
                    text.lower() == '–µ–≤–≥–µ—Ö–∞' or\
                    text.lower() == '–∂—ç–∫–∞':
                    text = '–ê'

                elif text.lower() == 'how to praise the sun?' or\
                     text.lower() == 'üåû':
                    text = '\\[T]/\n..üåû\n...||\n'

                elif re.sub('^( )*', '', text).startswith('/'): 
                    text = text[1:]
                    if text.startswith('/'):
                        mark_msg = False
                        text = text[1:]

                    text = parse_input(text, replace_vkurl=False, replace_nl=False)
                    words = text.split()

                    if not words: 
                        words = ' '

                    if  re.match(u'(^help)|(^–ø–æ–º–æ—â—å)|(^info)|(^–∏–Ω—Ñ–æ)|(^–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)|^\?$',\
                        words[0].lower()):
                        text = self.bot.help()

                    elif re.match(u'(^—Å–∫–∞–∂–∏)|(^say)$', words[0].lower()):
                        text = self.bot.say(words)
                        
                    elif re.match(u'(^–ø–æ—Å—á–∏—Ç–∞–π)|(^calculate)|$', words[0].lower()) or\
                         words[0].startswith('='):
                        text = self.bot.calculate(words)
                                        
                    elif re.match(u'(^–ø—Ä–æ—Å—Ç–æ–µ)|(^prime)|%$', words[0].lower()):
                        text = self.bot.prime(words)

                    elif re.match(u'(^stop)|(^–≤—ã–π—Ç–∏)|(^exit)|(^—Å—Ç–æ–ø)|(^terminate)|(^–∑–∞–≤–µ—Ä—à–∏—Ç—å)|(^close)|^!$', words[0].lower()):
                        self.run_self, text = self.bot.stop(response=update, self_id=self.SELF_ID)

                    else:
                        text = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.'
                else:
                    continue
                
                if not text:
                    continue
                
                if update[5] != ' ... ':
                    message_to_resend = update[1]
                else:
                    message_to_resend = None

                self.last_rnd_id = update[8] + 9

                vkr.send_message(
                    uid = update[3],
                    text = text + "'" if mark_msg else text,
                    forward = message_to_resend,
                    rnd_id = self.last_rnd_id
                    )
                self.reply_count += 1

                if not self.run_self:
                    self.__exit__()

class Bot(object):
    def __init__(self):
        pass
    
    def help(self):
        return __help__
    
    def say(self, words):
        argument_required = self._argument_missing(words)
        if argument_required:
            return argument_required

        del words[0]
        return ' '.join(words)
        
    def calculate(self, words):
        argument_required = self._argument_missing(words)
        if argument_required:
            return argument_required

        if words[0].startswith('='):
            words[0] = words[0][1:]
        else:
            del words[0]
        words = ''.join(words).lower()
        if not re.match(u'[^\d+\-*/:().,^‚àöœÄe]', words) or re.match('(sqrt\(\d+\))|(pi)', words):
            words = ' ' + words + ' '
            words = re.sub(u'(sqrt)|‚àö', 'math.sqrt', words)
            words = re.sub(u'(pi)|œÄ', 'math.pi', words)
            words = re.sub('\^', '**', words)
            words = re.sub(',', '.', words)
            words = re.sub(':', '/', words)            
            while True:
                if '/' in words:
                    index = re.search('[^.\d]\d+[^.\de]', words)
                    if index:
                        index = index.end() - 1
                        words = words[:index] + '.' + words[index:]
                    else:
                        break
                else:
                    break
            try:
                result = str(eval(words))
            except SyntaxError:
                result = '–û—à–∏–±–∫–∞ [0]'
            except NameError:
                result = '–û—à–∏–±–∫–∞ [1]'
            except AttributeError:
                result = '–û—à–∏–±–∫–∞ [2]'        
            except ZeroDivisionError:
                result = '–î–µ–ª–µ–Ω–∏–µ –Ω–∞ 0'
            except OverflowError:
                result = '–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç'
        else:
            result = '–ù–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è'
        return result
            
    def prime(self, words):
        argument_required = self._argument_missing(words)
        if argument_required:
            return argument_required

        del words[0]
        input_number = ''.join(words)
        if re.match('^\d+$', input_number) and len(input_number)<=5:
            input_number = int(input_number)
            luc_number = 0
            last_luc_number = 0
            for i in range(input_number):
                if luc_number == 0:
                    luc_number = 1
                elif luc_number == 1:
                    last_luc_number = luc_number
                    luc_number = 3
                else:
                    luc_number, last_luc_number = last_luc_number + luc_number, luc_number
                            
            if input_number != 0:
                is_prime = True if (luc_number - 1) % input_number == 0 else False
                result = '–Ø–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Å—Ç—ã–º —á–∏—Å–ª–æ–º' if is_prime else '–ù–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Å—Ç—ã–º —á–∏—Å–ª–æ–º'
            else:
                result = '0 –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Å—Ç—ã–º —á–∏—Å–ª–æ–º'
        else:
            result = '–î–∞–Ω–æ –Ω–µ–≤–µ—Ä–Ω–æ–µ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ'
        return result

    def stop(self, response, self_id):
        refuse = True
        text = '–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ'
        if 'from' in response[7]:
            if int(response[7]['from']) == self_id:
                text = '–ó–∞–≤–µ—Ä—à–∞—é –ø—Ä–æ–≥—Ä–∞–º–º—É'
                refuse = False
        else:
            out = False
            sum_flags = response[2]
            for flag in [512,256,128,64,32,16,8,4]:
                if sum_flags == 3 or sum_flags == 2:
                    out = True
                    break
                if sum_flags - flag <= 0:
                    continue
                else:
                    if sum_flags - flag == 3 or sum_flags - flag == 2:
                        out = True
                        break
                    else:
                        sum_flags -= flag
            if out:
                text = '–ó–∞–≤–µ—Ä—à–∞—é –ø—Ä–æ–≥—Ä–∞–º–º—É'
                refuse = False

        return refuse, text

    def _argument_missing(self, words):
        if len(words) == 1:
            return '–ö–æ–º–∞–Ω–¥—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º'
        else:
            return False

def main():
    session = LongPollSession(bot=Bot())
    while not session.authorization(token_path='/storage/emulated/0/Git/ChatBot/data/token.txt'):
        continue

    #session.flood(chat_id=2000000127)
    session.process_updates()

def bot_debug():
    bot = Bot()
    while True:
        command = raw_input('command: ').lower()
        args = ('command ' + raw_input('args: ')).split(' ')
        try: print eval('bot.' + command + '(' + str(args) + ')')
        except Exception as e: print 'error! ' + str(e)

if __name__ == '__main__':
    main()
    #bot_debug()
